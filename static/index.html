<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Governance Gateway</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --sidebar-bg: #020617;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --success: #4ade80;
            --error: #f87171;
            --border: #334155;
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            /* Prevent body scroll, handle in main */
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-item:hover {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: rgba(56, 189, 248, 0.15);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        /* Main Content Styles */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem 3rem;
            max-width: 1200px;
            /* Wider/Clean constraint */
            margin: 0 auto;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card & Utility Styles */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        h3 {
            color: var(--text-primary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--border);
            transition: background-color 0.3s;
        }

        .dot.active {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .dot.error {
            background-color: var(--error);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background-color: var(--accent);
            color: #0f172a;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Console Grid */
        .console-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            height: 600px;
            /* Fixed height for console view */
        }

        #logs {
            font-family: 'Fira Code', monospace;
            background-color: #000;
            padding: 1rem;
            border-radius: 6px;
            color: #10b981;
            height: 100%;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            box-sizing: border-box;
        }

        /* Integration Grid */
        .integration-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .code-block {
            background: #0f172a;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #334155;
        }

        pre {
            margin: 0;
            font-size: 0.75rem;
            color: #cbd5e1;
            font-family: 'Fira Code', monospace;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                overflow: auto;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                padding: 1rem;
                align-items: center;
                justify-content: space-between;
                position: sticky;
                top: 0;
                z-index: 10;
                border-bottom: 1px solid var(--border);
                border-right: none;
            }

            .brand {
                margin-bottom: 0;
                font-size: 1.25rem;
            }

            .nav-menu {
                flex-direction: row;
            }

            .nav-item {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }

            .main-content {
                padding: 1.5rem;
                height: auto;
                overflow: visible;
            }

            .console-grid,
            .integration-grid {
                grid-template-columns: 1fr;
                height: auto;
            }

            #logs {
                min-height: 300px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="brand">ATLAS Gateway</div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchView('dashboard', this)">
                <span>üìä</span> Dashboard
            </li>
            <li class="nav-item" onclick="switchView('console', this)">
                <span>üíª</span> Test Console
            </li>
            <li class="nav-item" onclick="switchView('integration', this)">
                <span>üîå</span> Integration
            </li>
            <li class="nav-item" onclick="switchView('docs', this)">
                <span>üìö</span> Documentation
            </li>
        </ul>

        <!-- Status Footer in Sidebar for Desktop -->
        <div style="margin-top: auto; padding-top: 2rem; display: none;">
            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                Status: <span id="sidebar-status" style="color: var(--success);">Online</span>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-dashboard" class="view-section active">
            <header style="margin-bottom: 2rem;">
                <h1>System Overview</h1>
                <p style="color: var(--text-secondary);">Real-time status of the ATLAS Governance Gateway.</p>
            </header>

            <div class="card">
                <h2>Health Status</h2>
                <div class="status-indicator" style="margin-bottom: 1.5rem;">
                    <div class="dot" id="health-dot"></div>
                    <span id="health-text" style="font-size: 1.1rem;">Checking connection...</span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div
                        style="background: rgba(15, 23, 42, 0.5); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Inngest
                            Cloud</div>
                        <div id="inngest-status" style="font-weight: 600; color: var(--text-primary);">Unknown</div>
                    </div>
                    <div
                        style="background: rgba(15, 23, 42, 0.5); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Modal SLM
                            Infrastructure</div>
                        <div id="modal-status" style="font-weight: 600; color: var(--text-primary);">Unknown</div>
                    </div>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(145deg, #1e293b, #0f172a);">
                <h2>Quick Actions</h2>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="switchView('console', document.querySelectorAll('.nav-item')[1])"
                        style="width: auto;">Open Test Console</button>
                    <button onclick="switchView('integration', document.querySelectorAll('.nav-item')[2])"
                        style="background: transparent; border: 1px solid var(--border); color: var(--text-primary); width: auto;">View
                        Setup Guide</button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: CONSOLE -->
        <div id="view-console" class="view-section">
            <header style="margin-bottom: 1.5rem;">
                <h1>Test Console</h1>
                <p style="color: var(--text-secondary);">Simulate Agent interactions and view live responses.</p>
            </header>

            <div class="console-grid">
                <!-- Left: Controls -->
                <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column;">
                    <h2>Configuration</h2>
                    <div class="form-group">
                        <label>API Key (Required)</label>
                        <input type="password" id="api-key" placeholder="Enter ATLAS_API_KEY">
                    </div>
                    <div class="form-group">
                        <label>Test Scenario</label>
                        <select id="scenario">
                            <option value="check_payment">Check Payment Status (Low Risk)</option>
                            <option value="request_extension">Request Payment Extension (High Risk)</option>
                            <option value="approve_scenario">Scenario: Approve (Low Risk)</option>
                            <option value="deny_scenario">Scenario: Deny (High Income)</option>
                            <option value="escalate_scenario">Scenario: Escalate (ID Mismatch)</option>
                        </select>
                    </div>
                    <div style="margin-top: auto;">
                        <button onclick="runTest()" id="test-btn">Run Test</button>
                    </div>
                </div>

                <!-- Right: Logs -->
                <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column;">
                    <h2>Response Log</h2>
                    <div id="logs">// Waiting for action...</div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: INTEGRATION -->
        <div id="view-integration" class="view-section">
            <header style="margin-bottom: 2rem;">
                <h1>Integration Guide</h1>
                <p style="color: var(--text-secondary);">Setup instructions for AI Agents and Sara's Portal.</p>
            </header>

            <div class="integration-grid">
                <!-- Client Setup -->
                <div>
                    <h3>1. Client Agent Setup</h3>
                    <div class="card">
                        <h4 style="color: #cbd5e1; margin-bottom: 0.5rem; margin-top:0;">ü§ñ AI Agent (Claude/Cursor)
                        </h4>
                        <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 1rem;">Add this to
                            <code>claude_desktop_config.json</code>:
                        </p>
                        <div class="code-block">
                            <pre>
"atlas-gateway": {
  "command": "npx",
  "args": [
    "-y",
    "@modelcontextprotocol/server-sse",
    "--url", "https://atlas-mcp-gateway-vercel.vercel.app/mcp/sse",
    "--header", "Authorization: Bearer <YOUR_KEY>"
  ]
}</pre>
                        </div>
                    </div>
                </div>

                <!-- Sara's Portal Title Block -->
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <div class="card" style="border-left: 4px solid #38bdf8;">
                        <h3 style="margin-top: 0;">üë§ Sara's Portal (HITL)</h3>
                        <p style="color: #cbd5e1; font-size: 0.95rem;">
                            The "Human-in-the-Loop" portal listens for High Risk events and provides manual approvals
                            using Inngest.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Full Width Sara's Portal Code -->
            <div class="card" style="margin-top: 1.5rem;">
                <h3>2. Sara's Portal Integration Code</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Listen -->
                    <div>
                        <div
                            style="font-size: 0.75rem; color: #38bdf8; margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase;">
                            Step 1: Listen (Inngest)</div>
                        <div class="code-block">
                            <pre>
inngest.createFunction(
  { id: "human-approval" },
  { event: "<span style="color: #38bdf8;">atlas/tool.execution_requested</span>" },
  async ({ event, step }) => {
    // 1. Notify Human
    await step.run("notify", async () => {
      await sendSlackNotification(event.data);
    });
    
    // 2. Wait for Decision
    const decision = await step.waitForEvent(
      "approval.received", 
      { timeout: "24h" }
    );
    return decision;
  }
);</pre>
                        </div>
                    </div>

                    <!-- Respond -->
                    <div>
                        <div
                            style="font-size: 0.75rem; color: #4ade80; margin-bottom: 0.5rem; font-weight: 700; text-transform: uppercase;">
                            Step 2: Respond (Webhook)</div>
                        <div class="code-block">
                            <pre>
// POST /webhook/approval
await fetch("<span style="color: #4ade80;">.../webhook/approval</span>", {
  method: "POST",
  headers: { 
    "Content-Type": "application/json",
    "Authorization": "Bearer KEY" 
  },
  body: JSON.stringify({
    event_id: event.data.event_id,
    decision: "<span style="color: #4ade80;">APPROVED</span>",
    notes: "Verified documents."
  })
});</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: DOCUMENTATION -->
        <div id="view-docs" class="view-section">
            <header style="margin-bottom: 2rem;">
                <h1>System Documentation</h1>
                <p style="color: var(--text-secondary);">Architecture, Tools, and Governance Standards.</p>
            </header>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Architecture -->
                <div>
                    <h3>1. System Architecture</h3>
                    <div class="card"
                        style="height: 400px; display: flex; align-items: center; justify-content: center; position: relative;">
                        <pre class="mermaid" style="background: transparent;">
                            graph TD
                            Agent[AI Agent]
                            Gateway{ATLAS Gateway}
                            Brain([Modal SLM])
                            Inngest[Inngest]
                            Human([Sara Portal])

                            Agent -->|Tools| Gateway
                            Gateway -.->|Risk Analysis| Brain
                            Gateway -->|Trigger Event| Inngest
                            Inngest -.->|Wait for Approval| Human
                            Human -.->|Webhook Response| Inngest

                            click Brain "https://huggingface.co/nislam-mics/ATLAS-NIST-Measure" "View Model on Hugging Face" _blank
                            click Inngest "https://www.inngest.com" "Visit Inngest Website" _blank
                            click Human "https://cyber295atlas.app/" "Open Sara's Portal" _blank
                        </pre>
                        <div
                            style="position: absolute; bottom: 10px; right: 10px; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.8;">
                            <span style="vertical-align: middle;">üëÜ</span> Nodes with solid borders are clickable
                        </div>
                    </div>
                </div>

                <!-- System Prompt -->
                <div>
                    <h3>2. Governance Compliance</h3>
                    <div class="card" style="border-left: 4px solid #38bdf8; height: 400px; overflow-y: auto;">
                        <h4 style="color: #38bdf8; margin-top: 0;">üõ°Ô∏è NIST & EU AI Act Prompt</h4>
                        <div class="code-block">
                            <pre style="white-space: pre-wrap;">
### CORE DIRECTIVES

1. **NIST AI RMF (Measure Function)**:
   - You must **QUANTIFY** risk in your internal reasoning.
   - Output `measure: { "risk_level": "LOW" | "HIGH" }`.

2. **EU AI Act (Article 14)**:
   - **PROHIBITED** from autonomously finalizing high-impact decisions.
   - If `risk_level` is HIGH, trigger `request_payment_extension`.
</pre>
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 2rem;">3. Available Tools Reference</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <!-- Tool Cards from before -->
                <div class="card" style="border-left: 4px solid #10b981;">
                    <h4 style="color: #10b981; margin-top: 0;">check_payment_status</h4>
                    <p style="font-size: 0.85rem; color: #cbd5e1;"><strong>üîç Low Risk</strong>: Auto-approved read
                        operation.</p>
                </div>
                <div class="card" style="border-left: 4px solid #f59e0b;">
                    <h4 style="color: #f59e0b; margin-top: 0;">request_payment_extension</h4>
                    <p style="font-size: 0.85rem; color: #cbd5e1;"><strong>‚ö†Ô∏è High Risk</strong>: Triggers Governance
                        Workflow.</p>
                </div>
                <div class="card" style="border-left: 4px solid #ef4444;">
                    <h4 style="color: #ef4444; margin-top: 0;">modify_welfare_record</h4>
                    <p style="font-size: 0.85rem; color: #cbd5e1;"><strong>üö® Critical Risk</strong>: Strictly
                        Human-in-the-Loop only.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Scripts -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
        window.mermaid = mermaid;
    </script>

    <script>
        const BASE_URL = window.location.origin;

        // View Switching Logic
        function switchView(viewName, navItem) {
            // 1. Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

            // 2. Show target view
            document.getElementById('view-' + viewName).classList.add('active');

            // 3. Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (navItem) {
                navItem.classList.add('active');
            } else {
                // Find by text if passed via button
            }

            // Explicitly render mermaid if switching to docs
            if (viewName === 'docs' && window.mermaid) {
                setTimeout(() => {
                    window.mermaid.run({
                        nodes: document.querySelectorAll('.mermaid')
                    });
                }, 100);
            }
        }

        async function checkHealth() {
            try {
                const res = await fetch(`${BASE_URL}/health`);
                const data = await res.json();
                const dot = document.getElementById('health-dot');
                const text = document.getElementById('health-text');

                if (data.status && data.status.includes("ATLAS")) {
                    dot.classList.add('active');
                    dot.classList.remove('error');
                    text.textContent = "System Operational";
                    document.getElementById('inngest-status').textContent = "Active";
                    document.getElementById('modal-status').textContent = "Connected";
                } else { throw new Error(data.status); }
            } catch (e) {
                document.getElementById('health-dot').classList.add('error');
                document.getElementById('health-text').textContent = `Offline: ${e.message}`;
                document.getElementById('inngest-status').textContent = "Unreachable";
                document.getElementById('modal-status').textContent = "Unreachable";
                console.error(e);
            }
        }

        async function runTest() {
            const btn = document.getElementById('test-btn');
            const logs = document.getElementById('logs');
            const apiKey = document.getElementById('api-key').value;
            const scenario = document.getElementById('scenario').value;

            if (!apiKey) { alert("Please enter your API Key."); return; }

            btn.disabled = true;
            btn.textContent = "Running...";
            logs.innerText = `> Initializing request for ${scenario}...\n`;

            try {
                const res = await fetch(`${BASE_URL}/api/test-tool`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ tool: scenario })
                });

                const data = await res.json();
                const timestamp = new Date().toLocaleTimeString();
                logs.innerText += `> [${timestamp}] ${res.ok ? 'Success' : 'Error'}:\n${JSON.stringify(data, null, 2)}\n`;
            } catch (e) {
                logs.innerText += `> Network Error: ${e.message}\n`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Run Test";
            }
        }

        // Init
        checkHealth();
    </script>
</body>

</html>